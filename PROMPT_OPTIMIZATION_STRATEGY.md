# ğŸš€ PromptValar - æç¤ºè¯ç­–ç•¥ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-25  
> **ç›®æ ‡**: é€šè¿‡æ•°æ®é©±åŠ¨çš„æ–¹å¼æŒç»­ä¼˜åŒ–æç¤ºè¯ç”Ÿæˆè´¨é‡

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#æ–¹æ¡ˆæ¦‚è¿°)
2. [æ ¸å¿ƒä»·å€¼](#æ ¸å¿ƒä»·å€¼)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
6. [ä»£ç å®ç°](#ä»£ç å®ç°)
7. [ç›‘æ§æŒ‡æ ‡](#ç›‘æ§æŒ‡æ ‡)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [è¿›é˜¶ä¼˜åŒ–](#è¿›é˜¶ä¼˜åŒ–)

---

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

### é—®é¢˜èƒŒæ™¯

å½“å‰çš„æç¤ºè¯ç”Ÿæˆç³»ç»Ÿä½¿ç”¨å›ºå®šçš„ç­–ç•¥ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ æ— æ³•æ ¹æ®ç”¨æˆ·åé¦ˆæ”¹è¿›
- âŒ ä¸åŒAIæ¨¡å‹ä½¿ç”¨ç›¸åŒç­–ç•¥
- âŒ ç¼ºä¹è´¨é‡ç›‘æ§æœºåˆ¶
- âŒ æ— æ³•è¿›è¡ŒA/Bæµ‹è¯•
- âŒ éš¾ä»¥è¿½è¸ªç”Ÿæˆæ•ˆæœ

### è§£å†³æ–¹æ¡ˆ

æ„å»ºä¸€ä¸ª**æ•°æ®é©±åŠ¨çš„æç¤ºè¯ä¼˜åŒ–ç³»ç»Ÿ**ï¼Œå®ç°ï¼š
- âœ… ç‰ˆæœ¬åŒ–çš„ç­–ç•¥ç®¡ç†
- âœ… ç”¨æˆ·åé¦ˆæ”¶é›†å’Œåˆ†æ
- âœ… A/Bæµ‹è¯•æ¡†æ¶
- âœ… è‡ªåŠ¨åŒ–æ€§èƒ½ç›‘æ§
- âœ… AIé©±åŠ¨çš„ç­–ç•¥ä¼˜åŒ–

---

## ğŸ’ æ ¸å¿ƒä»·å€¼

### 1. æŒç»­æ”¹è¿›
é€šè¿‡æ”¶é›†ç”¨æˆ·åé¦ˆå’Œä½¿ç”¨æ•°æ®ï¼ŒæŒç»­ä¼˜åŒ–æç¤ºè¯ç”Ÿæˆè´¨é‡

### 2. ä¸ªæ€§åŒ–
æ ¹æ®ä¸åŒæ¨¡å‹ã€é£æ ¼ã€ç”¨æˆ·ç¾¤ä½“æä¾›å®šåˆ¶åŒ–ç­–ç•¥

### 3. æ•°æ®é©±åŠ¨
æ‰€æœ‰ä¼˜åŒ–å†³ç­–åŸºäºçœŸå®æ•°æ®ï¼Œè€Œéä¸»è§‚åˆ¤æ–­

### 4. å¿«é€Ÿè¿­ä»£
æ–°ç­–ç•¥å¯ä»¥å¿«é€Ÿéƒ¨ç½²å’Œæµ‹è¯•ï¼Œé™ä½è¯•é”™æˆæœ¬

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç”Ÿæˆæç¤ºè¯   â”‚  â”‚   è¯„åˆ†åé¦ˆ   â”‚  â”‚   ä½¿ç”¨è·Ÿè¸ª   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç­–ç•¥è·¯ç”±å™¨   â”‚  â”‚  A/Bæµ‹è¯•     â”‚  â”‚ åé¦ˆæ”¶é›†å™¨   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç­–ç•¥å¼•æ“å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç­–ç•¥åº“       â”‚  â”‚  ä¼˜åŒ–å™¨      â”‚  â”‚  æ¨¡æ¿ç®¡ç†    â”‚      â”‚
â”‚  â”‚ (å¤šç‰ˆæœ¬)     â”‚  â”‚  (AIé©±åŠ¨)    â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åˆ†æå±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ æ—¥å¿—è®°å½•     â”‚  â”‚  æ€§èƒ½åˆ†æ    â”‚  â”‚  æ¨¡å¼è¯†åˆ«    â”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  (æœºå™¨å­¦ä¹ )  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å­˜å‚¨å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚   Redis      â”‚  â”‚  æ—¶åºæ•°æ®åº“  â”‚      â”‚
â”‚  â”‚ (ä¸»æ•°æ®)     â”‚  â”‚  (ç¼“å­˜)      â”‚  â”‚  (ç›‘æ§)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æç¤ºè¯æ¨¡æ¿è¡¨ (prompt_templates)

ç”¨äºå­˜å‚¨ä¸åŒç‰ˆæœ¬çš„æç¤ºè¯ç”Ÿæˆç­–ç•¥

```sql
CREATE TABLE prompt_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,                    -- æ¨¡æ¿åç§° (e.g., "Soraä¼˜åŒ–ç‰ˆv2.0")
  model VARCHAR(50) NOT NULL,                    -- ç›®æ ‡AIæ¨¡å‹ (sora, midjourney, etc.)
  version VARCHAR(20) NOT NULL,                  -- ç‰ˆæœ¬å· (v1.0, v1.1, v2.0)
  system_prompt TEXT NOT NULL,                   -- Systemæç¤ºè¯
  user_prompt_template TEXT NOT NULL,            -- Useræç¤ºè¯æ¨¡æ¿ï¼ˆå¸¦å˜é‡ï¼‰
  is_active BOOLEAN DEFAULT true,                -- æ˜¯å¦å¯ç”¨
  success_rate INTEGER DEFAULT 0,                -- æˆåŠŸç‡ (0-100)
  avg_rating DECIMAL(3,2) DEFAULT 0.00,         -- å¹³å‡è¯„åˆ† (0.00-5.00)
  usage_count INTEGER DEFAULT 0,                 -- ä½¿ç”¨æ¬¡æ•°
  metadata JSONB,                                -- é¢å¤–é…ç½® (æ¸©åº¦ã€max_tokensç­‰)
  created_by UUID REFERENCES users(id),          -- åˆ›å»ºè€…
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•
  INDEX idx_model (model),
  INDEX idx_active (is_active),
  INDEX idx_success_rate (success_rate DESC),
  
  -- å”¯ä¸€çº¦æŸï¼šåŒä¸€æ¨¡å‹çš„åŒä¸€ç‰ˆæœ¬åªèƒ½æœ‰ä¸€ä¸ª
  UNIQUE(model, version)
);
```

**å­—æ®µè¯´æ˜**:
- `system_prompt`: AIçš„è§’è‰²å®šä¹‰ï¼Œä¾‹å¦‚"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Soraæç¤ºè¯å·¥ç¨‹å¸ˆ"
- `user_prompt_template`: ç”¨æˆ·è¾“å…¥çš„æ¨¡æ¿ï¼Œä½¿ç”¨ `{{idea}}`, `{{style}}` ç­‰å ä½ç¬¦
- `metadata`: å­˜å‚¨å¦‚ `{"temperature": 0.7, "max_tokens": 2000}` ç­‰é…ç½®

### 2. æç¤ºè¯ç”Ÿæˆæ—¥å¿—è¡¨ (prompt_generation_logs)

è®°å½•æ¯æ¬¡æç¤ºè¯ç”Ÿæˆçš„è¯¦ç»†ä¿¡æ¯ï¼Œç”¨äºåˆ†æå’Œä¼˜åŒ–

```sql
CREATE TABLE prompt_generation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),             -- ç”¨æˆ·ID
  template_id UUID REFERENCES prompt_templates(id), -- ä½¿ç”¨çš„æ¨¡æ¿ID
  
  -- è¾“å…¥æ•°æ®
  input_idea TEXT NOT NULL,                      -- ç”¨æˆ·è¾“å…¥çš„æƒ³æ³•
  input_model VARCHAR(50) NOT NULL,              -- é€‰æ‹©çš„AIæ¨¡å‹
  input_style VARCHAR(50),                       -- é€‰æ‹©çš„é£æ ¼
  
  -- è¾“å‡ºæ•°æ®
  output_prompt TEXT NOT NULL,                   -- ç”Ÿæˆçš„æç¤ºè¯
  output_structured JSONB,                       -- ç»“æ„åŒ–æ•°æ®
  
  -- æ€§èƒ½æŒ‡æ ‡
  generation_time INTEGER,                       -- ç”Ÿæˆè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  tokens_used INTEGER,                           -- ä½¿ç”¨çš„tokenæ•°
  ai_model_used VARCHAR(100),                    -- å®é™…ä½¿ç”¨çš„AIæ¨¡å‹
  
  -- åé¦ˆæ•°æ®
  user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5), -- ç”¨æˆ·è¯„åˆ† 1-5
  is_successful BOOLEAN,                         -- æ˜¯å¦æˆåŠŸ
  user_feedback TEXT,                            -- ç”¨æˆ·æ–‡å­—åé¦ˆ
  was_copied BOOLEAN DEFAULT false,              -- æ˜¯å¦è¢«å¤åˆ¶ä½¿ç”¨
  was_saved BOOLEAN DEFAULT false,               -- æ˜¯å¦è¢«ä¿å­˜
  
  -- å…ƒæ•°æ®
  user_agent TEXT,                               -- ç”¨æˆ·è®¾å¤‡ä¿¡æ¯
  ip_address INET,                               -- IPåœ°å€ï¼ˆç”¨äºåœ°åŸŸåˆ†æï¼‰
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  rated_at TIMESTAMP,                            -- è¯„åˆ†æ—¶é—´
  
  -- ç´¢å¼•
  INDEX idx_user_logs (user_id, created_at DESC),
  INDEX idx_template_logs (template_id, created_at DESC),
  INDEX idx_rating (user_rating),
  INDEX idx_successful (is_successful),
  INDEX idx_created_at (created_at DESC)
);
```

### 3. æç¤ºè¯è¯„åˆ†è¡¨ (prompt_ratings)

ç”¨æˆ·å¯¹å·²å‘å¸ƒæç¤ºè¯çš„è¯„åˆ†

```sql
CREATE TABLE prompt_ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_id UUID REFERENCES prompts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  feedback TEXT,                                 -- æ–‡å­—åé¦ˆ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- ä¸€ä¸ªç”¨æˆ·åªèƒ½å¯¹ä¸€ä¸ªæç¤ºè¯è¯„åˆ†ä¸€æ¬¡
  UNIQUE(prompt_id, user_id),
  
  INDEX idx_prompt_ratings (prompt_id)
);
```

### 4. A/Bæµ‹è¯•é…ç½®è¡¨ (ab_test_experiments)

ç®¡ç†A/Bæµ‹è¯•å®éªŒ

```sql
CREATE TABLE ab_test_experiments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,                    -- å®éªŒåç§°
  description TEXT,                              -- å®éªŒæè¿°
  model VARCHAR(50),                             -- é’ˆå¯¹çš„æ¨¡å‹
  
  -- æµ‹è¯•ç»„é…ç½®
  control_template_id UUID REFERENCES prompt_templates(id), -- å¯¹ç…§ç»„æ¨¡æ¿
  variant_template_id UUID REFERENCES prompt_templates(id), -- å®éªŒç»„æ¨¡æ¿
  
  traffic_split INTEGER DEFAULT 50,              -- æµé‡åˆ†é…æ¯”ä¾‹ (0-100)
  
  -- å®éªŒçŠ¶æ€
  status VARCHAR(20) DEFAULT 'draft',            -- draft, running, paused, completed
  start_date TIMESTAMP,
  end_date TIMESTAMP,
  
  -- ç»“æœç»Ÿè®¡
  control_conversions INTEGER DEFAULT 0,
  variant_conversions INTEGER DEFAULT 0,
  control_samples INTEGER DEFAULT 0,
  variant_samples INTEGER DEFAULT 0,
  
  winner VARCHAR(20),                            -- control, variant, or null
  
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_status (status),
  INDEX idx_model (model)
);
```

### 5. A/Bæµ‹è¯•åˆ†é…è¡¨ (ab_test_assignments)

è®°å½•ç”¨æˆ·è¢«åˆ†é…åˆ°å“ªä¸ªæµ‹è¯•ç»„

```sql
CREATE TABLE ab_test_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  experiment_id UUID REFERENCES ab_test_experiments(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  variant VARCHAR(20) NOT NULL,                  -- control æˆ– variant
  assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(experiment_id, user_id),
  INDEX idx_experiment_assignments (experiment_id, variant)
);
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### é˜¶æ®µ 1: åŸºç¡€è®¾æ–½æ­å»º (ç¬¬1-2å‘¨)

#### 1.1 åˆ›å»ºæ•°æ®åº“è¡¨

```bash
# è¿è¡Œè¿ç§»è„šæœ¬
cd backend
npm run db:migrate
```

#### 1.2 å®ç°æ—¥å¿—è®°å½•æœåŠ¡

åˆ›å»º `backend/src/services/loggingService.ts`ï¼š

```typescript
import { db } from '../db/index.js';
import { promptGenerationLogs } from '../db/schema.js';

interface GenerationLogData {
  userId?: string;
  templateId: string;
  inputIdea: string;
  inputModel: string;
  inputStyle?: string;
  outputPrompt: string;
  outputStructured?: any;
  generationTime: number;
  tokensUsed: number;
  aiModelUsed: string;
}

export class LoggingService {
  /**
   * è®°å½•æç¤ºè¯ç”Ÿæˆæ—¥å¿—
   */
  async logGeneration(data: GenerationLogData): Promise<string> {
    const [log] = await db
      .insert(promptGenerationLogs)
      .values({
        userId: data.userId,
        templateId: data.templateId,
        inputIdea: data.inputIdea,
        inputModel: data.inputModel,
        inputStyle: data.inputStyle,
        outputPrompt: data.outputPrompt,
        outputStructured: data.outputStructured,
        generationTime: data.generationTime,
        tokensUsed: data.tokensUsed,
        aiModelUsed: data.aiModelUsed,
      })
      .returning({ id: promptGenerationLogs.id });
    
    return log.id;
  }
  
  /**
   * è®°å½•ç”¨æˆ·åé¦ˆ
   */
  async logFeedback(
    logId: string,
    rating: number,
    isSuccessful: boolean,
    feedback?: string
  ) {
    await db
      .update(promptGenerationLogs)
      .set({
        userRating: rating,
        isSuccessful,
        userFeedback: feedback,
        ratedAt: new Date(),
      })
      .where(eq(promptGenerationLogs.id, logId));
    
    // æ›´æ–°æ¨¡æ¿çš„ç»Ÿè®¡æ•°æ®
    await this.updateTemplateStats(logId);
  }
  
  /**
   * è®°å½•ç”¨æˆ·è¡Œä¸ºï¼ˆå¤åˆ¶ã€ä¿å­˜ï¼‰
   */
  async logUserAction(logId: string, action: 'copy' | 'save') {
    const updates: any = {};
    
    if (action === 'copy') {
      updates.wasCopied = true;
    } else if (action === 'save') {
      updates.wasSaved = true;
    }
    
    await db
      .update(promptGenerationLogs)
      .set(updates)
      .where(eq(promptGenerationLogs.id, logId));
  }
  
  /**
   * æ›´æ–°æ¨¡æ¿ç»Ÿè®¡æ•°æ®
   */
  private async updateTemplateStats(logId: string) {
    // è·å–æ—¥å¿—ä¿¡æ¯
    const [log] = await db
      .select()
      .from(promptGenerationLogs)
      .where(eq(promptGenerationLogs.id, logId))
      .limit(1);
    
    if (!log || !log.templateId) return;
    
    // è®¡ç®—è¯¥æ¨¡æ¿çš„ç»Ÿè®¡æ•°æ®
    const stats = await db
      .select({
        avgRating: sql<number>`AVG(${promptGenerationLogs.userRating})`,
        successRate: sql<number>`
          (COUNT(CASE WHEN ${promptGenerationLogs.isSuccessful} = true THEN 1 END)::float / 
           COUNT(CASE WHEN ${promptGenerationLogs.userRating} IS NOT NULL THEN 1 END)::float * 100)`,
        usageCount: sql<number>`COUNT(*)`,
      })
      .from(promptGenerationLogs)
      .where(eq(promptGenerationLogs.templateId, log.templateId));
    
    // æ›´æ–°æ¨¡æ¿è¡¨
    await db
      .update(promptTemplates)
      .set({
        avgRating: stats[0].avgRating || 0,
        successRate: Math.round(stats[0].successRate || 0),
        usageCount: stats[0].usageCount || 0,
        updatedAt: new Date(),
      })
      .where(eq(promptTemplates.id, log.templateId));
  }
}

export const loggingService = new LoggingService();
```

#### 1.3 ä¿®æ”¹AIæœåŠ¡é›†æˆæ—¥å¿—

æ›´æ–° `backend/src/services/aiService.ts`ï¼š

```typescript
import { loggingService } from './loggingService.js';

export async function generatePrompt(
  userIdea: string,
  targetModel: string,
  style: string,
  userId?: string
) {
  const startTime = Date.now();
  
  try {
    // è·å–å½“å‰ä½¿ç”¨çš„æ¨¡æ¿
    const template = await getActiveTemplate(targetModel);
    
    // æ„å»ºæç¤ºè¯
    const systemPrompt = template.systemPrompt;
    const userPrompt = template.userPromptTemplate
      .replace('{{idea}}', userIdea)
      .replace('{{model}}', targetModel)
      .replace('{{style}}', style);
    
    // è°ƒç”¨AI
    const completion = await openrouter.chat.completions.create({
      model: 'anthropic/claude-3.5-sonnet',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
      ],
      temperature: template.metadata?.temperature || 0.7,
    });
    
    const generatedPrompt = completion.choices[0].message.content || '';
    const generationTime = Date.now() - startTime;
    
    // è®°å½•æ—¥å¿—
    const logId = await loggingService.logGeneration({
      userId,
      templateId: template.id,
      inputIdea: userIdea,
      inputModel: targetModel,
      inputStyle: style,
      outputPrompt: generatedPrompt,
      generationTime,
      tokensUsed: completion.usage?.total_tokens || 0,
      aiModelUsed: 'anthropic/claude-3.5-sonnet',
    });
    
    return {
      prompt: generatedPrompt,
      logId, // è¿”å›æ—¥å¿—IDä¾›å‰ç«¯ä½¿ç”¨
    };
  } catch (error) {
    console.error('ç”Ÿæˆå¤±è´¥:', error);
    throw error;
  }
}
```

---

### é˜¶æ®µ 2: ç­–ç•¥ç®¡ç†ç³»ç»Ÿ (ç¬¬3-4å‘¨)

#### 2.1 åˆ›å»ºç­–ç•¥ç®¡ç†æœåŠ¡

`backend/src/services/strategyService.ts`ï¼š

```typescript
import { db } from '../db/index.js';
import { promptTemplates } from '../db/schema.js';
import { eq, and, desc } from 'drizzle-orm';

export class StrategyService {
  /**
   * è·å–æŒ‡å®šæ¨¡å‹çš„æ´»è·ƒç­–ç•¥
   */
  async getActiveTemplate(model: string) {
    const [template] = await db
      .select()
      .from(promptTemplates)
      .where(
        and(
          eq(promptTemplates.model, model),
          eq(promptTemplates.isActive, true)
        )
      )
      .orderBy(desc(promptTemplates.avgRating))
      .limit(1);
    
    if (!template) {
      // è¿”å›é»˜è®¤æ¨¡æ¿
      return this.getDefaultTemplate(model);
    }
    
    return template;
  }
  
  /**
   * åˆ›å»ºæ–°ç­–ç•¥ç‰ˆæœ¬
   */
  async createTemplate(data: {
    name: string;
    model: string;
    version: string;
    systemPrompt: string;
    userPromptTemplate: string;
    metadata?: any;
    createdBy: string;
  }) {
    const [template] = await db
      .insert(promptTemplates)
      .values({
        name: data.name,
        model: data.model,
        version: data.version,
        systemPrompt: data.systemPrompt,
        userPromptTemplate: data.userPromptTemplate,
        metadata: data.metadata,
        createdBy: data.createdBy,
        isActive: false, // æ–°æ¨¡æ¿é»˜è®¤ä¸æ¿€æ´»
      })
      .returning();
    
    return template;
  }
  
  /**
   * æ¿€æ´»æŒ‡å®šæ¨¡æ¿ï¼ˆåŒæ—¶åœç”¨å…¶ä»–æ¨¡æ¿ï¼‰
   */
  async activateTemplate(templateId: string, model: string) {
    // åœç”¨è¯¥æ¨¡å‹çš„æ‰€æœ‰æ¨¡æ¿
    await db
      .update(promptTemplates)
      .set({ isActive: false })
      .where(eq(promptTemplates.model, model));
    
    // æ¿€æ´»æŒ‡å®šæ¨¡æ¿
    await db
      .update(promptTemplates)
      .set({ isActive: true, updatedAt: new Date() })
      .where(eq(promptTemplates.id, templateId));
  }
  
  /**
   * è·å–é»˜è®¤æ¨¡æ¿
   */
  private getDefaultTemplate(model: string) {
    return {
      id: 'default',
      name: `${model} é»˜è®¤æ¨¡æ¿`,
      model,
      version: 'v1.0',
      systemPrompt: `You are an expert prompt engineer specialized in ${model}. 
Generate professional, detailed prompts that maximize the model's capabilities.`,
      userPromptTemplate: `Generate a professional ${model} prompt for the following idea:

Idea: {{idea}}
Style: {{style}}

Create a detailed, optimized prompt that includes:
- Clear subject and action
- Specific visual details
- Appropriate technical parameters
- Style-specific elements`,
      isActive: true,
      metadata: { temperature: 0.7, max_tokens: 2000 },
    };
  }
  
  /**
   * åˆ—å‡ºæ‰€æœ‰æ¨¡æ¿
   */
  async listTemplates(filters?: {
    model?: string;
    isActive?: boolean;
  }) {
    let query = db.select().from(promptTemplates);
    
    const conditions = [];
    if (filters?.model) {
      conditions.push(eq(promptTemplates.model, filters.model));
    }
    if (filters?.isActive !== undefined) {
      conditions.push(eq(promptTemplates.isActive, filters.isActive));
    }
    
    if (conditions.length > 0) {
      query = query.where(and(...conditions));
    }
    
    return query.orderBy(desc(promptTemplates.createdAt));
  }
}

export const strategyService = new StrategyService();
```

#### 2.2 åˆ›å»ºç­–ç•¥ç®¡ç†API

`backend/src/routes/strategy.routes.ts`ï¼š

```typescript
import { Router } from 'express';
import { authenticate, isAdmin } from '../middleware/auth.middleware.js';
import { strategyService } from '../services/strategyService.js';

const router = Router();

/**
 * è·å–æ‰€æœ‰ç­–ç•¥æ¨¡æ¿ï¼ˆç®¡ç†å‘˜ï¼‰
 * GET /api/v1/strategies
 */
router.get('/', authenticate, isAdmin, async (req, res, next) => {
  try {
    const { model, isActive } = req.query;
    
    const templates = await strategyService.listTemplates({
      model: model as string,
      isActive: isActive === 'true' ? true : isActive === 'false' ? false : undefined,
    });
    
    res.json({
      success: true,
      data: templates,
    });
  } catch (error) {
    next(error);
  }
});

/**
 * åˆ›å»ºæ–°ç­–ç•¥æ¨¡æ¿ï¼ˆç®¡ç†å‘˜ï¼‰
 * POST /api/v1/strategies
 */
router.post('/', authenticate, isAdmin, async (req, res, next) => {
  try {
    const template = await strategyService.createTemplate({
      ...req.body,
      createdBy: req.user!.id,
    });
    
    res.status(201).json({
      success: true,
      data: template,
    });
  } catch (error) {
    next(error);
  }
});

/**
 * æ¿€æ´»ç­–ç•¥æ¨¡æ¿ï¼ˆç®¡ç†å‘˜ï¼‰
 * POST /api/v1/strategies/:id/activate
 */
router.post('/:id/activate', authenticate, isAdmin, async (req, res, next) => {
  try {
    const { id } = req.params;
    const { model } = req.body;
    
    await strategyService.activateTemplate(id, model);
    
    res.json({
      success: true,
      message: 'ç­–ç•¥å·²æ¿€æ´»',
    });
  } catch (error) {
    next(error);
  }
});

export default router;
```

---

### é˜¶æ®µ 3: ç”¨æˆ·åé¦ˆç³»ç»Ÿ (ç¬¬5-6å‘¨)

#### 3.1 åˆ›å»ºåé¦ˆAPI

`backend/src/routes/feedback.routes.ts`ï¼š

```typescript
import { Router } from 'express';
import { authenticate } from '../middleware/auth.middleware.js';
import { loggingService } from '../services/loggingService.js';
import { z } from 'zod';

const router = Router();

// è¯„åˆ†éªŒè¯schema
const ratingSchema = z.object({
  rating: z.number().int().min(1).max(5),
  isSuccessful: z.boolean(),
  feedback: z.string().optional(),
});

/**
 * å¯¹ç”Ÿæˆçš„æç¤ºè¯è¿›è¡Œè¯„åˆ†
 * POST /api/v1/feedback/generations/:logId/rate
 */
router.post('/generations/:logId/rate', authenticate, async (req, res, next) => {
  try {
    const { logId } = req.params;
    const validated = ratingSchema.parse(req.body);
    
    await loggingService.logFeedback(
      logId,
      validated.rating,
      validated.isSuccessful,
      validated.feedback
    );
    
    res.json({
      success: true,
      message: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼',
    });
  } catch (error) {
    next(error);
  }
});

/**
 * è®°å½•ç”¨æˆ·å¤åˆ¶æç¤ºè¯
 * POST /api/v1/feedback/generations/:logId/copy
 */
router.post('/generations/:logId/copy', async (req, res, next) => {
  try {
    const { logId } = req.params;
    
    await loggingService.logUserAction(logId, 'copy');
    
    res.json({ success: true });
  } catch (error) {
    next(error);
  }
});

export default router;
```

#### 3.2 å‰ç«¯åé¦ˆç»„ä»¶

`frontend/src/components/PromptRating.tsx`ï¼š

```tsx
import { useState } from 'react';
import { Star, ThumbsUp, ThumbsDown } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

interface PromptRatingProps {
  logId: string;
  onRated?: () => void;
}

export const PromptRating: React.FC<PromptRatingProps> = ({ logId, onRated }) => {
  const [rating, setRating] = useState<number>(0);
  const [hover, setHover] = useState<number>(0);
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedback, setFeedback] = useState('');
  const [submitted, setSubmitted] = useState(false);
  
  const handleRate = async (value: number) => {
    setRating(value);
    setShowFeedback(true);
  };
  
  const submitFeedback = async () => {
    const token = localStorage.getItem('authToken');
    
    try {
      await fetch(`http://localhost:5000/api/v1/feedback/generations/${logId}/rate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          rating,
          isSuccessful: rating >= 3,
          feedback: feedback || undefined,
        }),
      });
      
      setSubmitted(true);
      onRated?.();
      
      // 3ç§’åéšè—
      setTimeout(() => setShowFeedback(false), 3000);
    } catch (error) {
      console.error('æäº¤åé¦ˆå¤±è´¥:', error);
    }
  };
  
  if (submitted) {
    return (
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        className="flex items-center gap-2 text-green-400"
      >
        <ThumbsUp size={20} />
        <span>æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼</span>
      </motion.div>
    );
  }
  
  return (
    <div className="space-y-4">
      {/* æ˜Ÿçº§è¯„åˆ† */}
      <div className="flex items-center gap-3">
        <span className="text-gray-400 text-sm">è¿™ä¸ªæç¤ºè¯è´¨é‡å¦‚ä½•ï¼Ÿ</span>
        <div className="flex gap-1">
          {[1, 2, 3, 4, 5].map((value) => (
            <button
              key={value}
              onClick={() => handleRate(value)}
              onMouseEnter={() => setHover(value)}
              onMouseLeave={() => setHover(0)}
              className="transition-transform hover:scale-110 focus:outline-none"
            >
              <Star
                size={24}
                fill={(hover || rating) >= value ? '#fbbf24' : 'none'}
                className={`transition-colors ${
                  (hover || rating) >= value ? 'text-yellow-400' : 'text-gray-500'
                }`}
              />
            </button>
          ))}
        </div>
        {rating > 0 && (
          <span className="text-yellow-400 font-semibold">
            {rating === 5 ? 'å®Œç¾!' : rating === 4 ? 'å¾ˆå¥½!' : rating === 3 ? 'è¿˜è¡Œ' : rating === 2 ? 'ä¸€èˆ¬' : 'éœ€è¦æ”¹è¿›'}
          </span>
        )}
      </div>
      
      {/* åé¦ˆè¾“å…¥æ¡† */}
      <AnimatePresence>
        {showFeedback && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="space-y-3"
          >
            <textarea
              value={feedback}
              onChange={(e) => setFeedback(e.target.value)}
              placeholder="å‘Šè¯‰æˆ‘ä»¬æ›´å¤šç»†èŠ‚ï¼ˆå¯é€‰ï¼‰..."
              className="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 resize-none"
              rows={3}
            />
            <div className="flex gap-3">
              <button
                onClick={submitFeedback}
                className="flex-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-2 px-6 rounded-lg transition-all"
              >
                æäº¤åé¦ˆ
              </button>
              <button
                onClick={() => setShowFeedback(false)}
                className="px-6 py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors"
              >
                è·³è¿‡
              </button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};
```

#### 3.3 é›†æˆåˆ°Prompt Studioé¡µé¢

æ›´æ–° `frontend/src/pages/PromptStudioPage.tsx`ï¼š

```typescript
// åœ¨ç”Ÿæˆç»“æœåæ·»åŠ è¯„åˆ†ç»„ä»¶
const [generationLogId, setGenerationLogId] = useState<string | null>(null);

// ç”Ÿæˆæç¤ºè¯æ—¶ä¿å­˜logId
const handleGenerate = async () => {
  // ... ç°æœ‰ä»£ç  ...
  const data = await response.json();
  setGeneratedPrompt(data.data.prompt);
  setStructured(data.data.structured);
  setGenerationLogId(data.data.logId); // ä¿å­˜æ—¥å¿—ID
};

// åœ¨Step 2ä¸­æ·»åŠ è¯„åˆ†ç»„ä»¶
{generationLogId && (
  <div className="mt-6 pt-6 border-t border-gray-700">
    <PromptRating logId={generationLogId} />
  </div>
)}
```

---

### é˜¶æ®µ 4: A/Bæµ‹è¯•ç³»ç»Ÿ (ç¬¬7-8å‘¨)

#### 4.1 A/Bæµ‹è¯•æœåŠ¡

`backend/src/services/abTestService.ts`ï¼š

```typescript
import { db } from '../db/index.js';
import { abTestExperiments, abTestAssignments, promptTemplates } from '../db/schema.js';
import { eq, and } from 'drizzle-orm';

export class ABTestService {
  /**
   * åˆ›å»ºæ–°çš„A/Bæµ‹è¯•å®éªŒ
   */
  async createExperiment(data: {
    name: string;
    description: string;
    model: string;
    controlTemplateId: string;
    variantTemplateId: string;
    trafficSplit: number;
    createdBy: string;
  }) {
    const [experiment] = await db
      .insert(abTestExperiments)
      .values({
        name: data.name,
        description: data.description,
        model: data.model,
        controlTemplateId: data.controlTemplateId,
        variantTemplateId: data.variantTemplateId,
        trafficSplit: data.trafficSplit,
        status: 'draft',
        createdBy: data.createdBy,
      })
      .returning();
    
    return experiment;
  }
  
  /**
   * å¯åŠ¨å®éªŒ
   */
  async startExperiment(experimentId: string) {
    await db
      .update(abTestExperiments)
      .set({
        status: 'running',
        startDate: new Date(),
      })
      .where(eq(abTestExperiments.id, experimentId));
  }
  
  /**
   * ä¸ºç”¨æˆ·åˆ†é…æµ‹è¯•ç»„
   */
  async assignUser(
    experimentId: string,
    userId: string
  ): Promise<'control' | 'variant'> {
    // æ£€æŸ¥æ˜¯å¦å·²åˆ†é…
    const [existing] = await db
      .select()
      .from(abTestAssignments)
      .where(
        and(
          eq(abTestAssignments.experimentId, experimentId),
          eq(abTestAssignments.userId, userId)
        )
      )
      .limit(1);
    
    if (existing) {
      return existing.variant as 'control' | 'variant';
    }
    
    // è·å–å®éªŒé…ç½®
    const [experiment] = await db
      .select()
      .from(abTestExperiments)
      .where(eq(abTestExperiments.id, experimentId))
      .limit(1);
    
    if (!experiment || experiment.status !== 'running') {
      return 'control';
    }
    
    // åŸºäºç”¨æˆ·IDå“ˆå¸Œå€¼åˆ†é…
    const hash = this.hashUserId(userId);
    const variant = hash % 100 < experiment.trafficSplit ? 'variant' : 'control';
    
    // ä¿å­˜åˆ†é…
    await db.insert(abTestAssignments).values({
      experimentId,
      userId,
      variant,
    });
    
    // æ›´æ–°æ ·æœ¬æ•°
    if (variant === 'variant') {
      await db
        .update(abTestExperiments)
        .set({ variantSamples: sql`${abTestExperiments.variantSamples} + 1` })
        .where(eq(abTestExperiments.id, experimentId));
    } else {
      await db
        .update(abTestExperiments)
        .set({ controlSamples: sql`${abTestExperiments.controlSamples} + 1` })
        .where(eq(abTestExperiments.id, experimentId));
    }
    
    return variant;
  }
  
  /**
   * è·å–ç”¨æˆ·åº”è¯¥ä½¿ç”¨çš„æ¨¡æ¿
   */
  async getTemplateForUser(
    model: string,
    userId?: string
  ): Promise<any> {
    // æŸ¥æ‰¾æ­£åœ¨è¿è¡Œçš„å®éªŒ
    const [experiment] = await db
      .select()
      .from(abTestExperiments)
      .where(
        and(
          eq(abTestExperiments.model, model),
          eq(abTestExperiments.status, 'running')
        )
      )
      .limit(1);
    
    // æ²¡æœ‰å®éªŒï¼Œè¿”å›é»˜è®¤æ¨¡æ¿
    if (!experiment || !userId) {
      return this.getActiveTemplate(model);
    }
    
    // åˆ†é…ç”¨æˆ·åˆ°æµ‹è¯•ç»„
    const variant = await this.assignUser(experiment.id, userId);
    
    // è¿”å›å¯¹åº”çš„æ¨¡æ¿
    const templateId = variant === 'variant' 
      ? experiment.variantTemplateId 
      : experiment.controlTemplateId;
    
    const [template] = await db
      .select()
      .from(promptTemplates)
      .where(eq(promptTemplates.id, templateId))
      .limit(1);
    
    return template;
  }
  
  /**
   * è®°å½•è½¬åŒ–ï¼ˆç”¨æˆ·ç»™å‡ºå¥½è¯„ï¼‰
   */
  async recordConversion(experimentId: string, userId: string, converted: boolean) {
    // è·å–ç”¨æˆ·åˆ†ç»„
    const [assignment] = await db
      .select()
      .from(abTestAssignments)
      .where(
        and(
          eq(abTestAssignments.experimentId, experimentId),
          eq(abTestAssignments.userId, userId)
        )
      )
      .limit(1);
    
    if (!assignment || !converted) return;
    
    // æ›´æ–°è½¬åŒ–æ•°
    if (assignment.variant === 'variant') {
      await db
        .update(abTestExperiments)
        .set({ variantConversions: sql`${abTestExperiments.variantConversions} + 1` })
        .where(eq(abTestExperiments.id, experimentId));
    } else {
      await db
        .update(abTestExperiments)
        .set({ controlConversions: sql`${abTestExperiments.controlConversions} + 1` })
        .where(eq(abTestExperiments.id, experimentId));
    }
  }
  
  /**
   * åˆ†æå®éªŒç»“æœ
   */
  async analyzeExperiment(experimentId: string) {
    const [experiment] = await db
      .select()
      .from(abTestExperiments)
      .where(eq(abTestExperiments.id, experimentId))
      .limit(1);
    
    if (!experiment) {
      throw new Error('å®éªŒä¸å­˜åœ¨');
    }
    
    const controlRate = experiment.controlConversions / experiment.controlSamples;
    const variantRate = experiment.variantConversions / experiment.variantSamples;
    
    // è®¡ç®—ç»Ÿè®¡æ˜¾è‘—æ€§ï¼ˆå¡æ–¹æ£€éªŒï¼‰
    const chiSquare = this.calculateChiSquare(
      experiment.controlConversions,
      experiment.controlSamples,
      experiment.variantConversions,
      experiment.variantSamples
    );
    
    const isSignificant = chiSquare.pValue < 0.05;
    const winner = isSignificant 
      ? (variantRate > controlRate ? 'variant' : 'control')
      : null;
    
    return {
      controlRate,
      variantRate,
      improvement: ((variantRate - controlRate) / controlRate * 100).toFixed(2) + '%',
      isSignificant,
      pValue: chiSquare.pValue,
      winner,
    };
  }
  
  // è¾…åŠ©æ–¹æ³•
  private hashUserId(userId: string): number {
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
      hash = ((hash << 5) - hash) + userId.charCodeAt(i);
      hash = hash & hash;
    }
    return Math.abs(hash);
  }
  
  private calculateChiSquare(
    c1: number, n1: number,
    c2: number, n2: number
  ) {
    // ç®€åŒ–çš„å¡æ–¹æ£€éªŒå®ç°
    const p1 = c1 / n1;
    const p2 = c2 / n2;
    const pooled = (c1 + c2) / (n1 + n2);
    
    const se = Math.sqrt(pooled * (1 - pooled) * (1/n1 + 1/n2));
    const z = (p2 - p1) / se;
    const pValue = 2 * (1 - this.normalCDF(Math.abs(z)));
    
    return { z, pValue };
  }
  
  private normalCDF(z: number): number {
    // æ ‡å‡†æ­£æ€åˆ†å¸ƒç´¯ç§¯åˆ†å¸ƒå‡½æ•°çš„è¿‘ä¼¼
    const t = 1 / (1 + 0.2316419 * Math.abs(z));
    const d = 0.3989423 * Math.exp(-z * z / 2);
    const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return z > 0 ? 1 - p : p;
  }
  
  private async getActiveTemplate(model: string) {
    const [template] = await db
      .select()
      .from(promptTemplates)
      .where(
        and(
          eq(promptTemplates.model, model),
          eq(promptTemplates.isActive, true)
        )
      )
      .limit(1);
    
    return template;
  }
}

export const abTestService = new ABTestService();
```

---

### é˜¶æ®µ 5: æ•°æ®åˆ†æå’Œè‡ªåŠ¨ä¼˜åŒ– (ç¬¬9-10å‘¨)

#### 5.1 æ€§èƒ½åˆ†ææœåŠ¡

`backend/src/services/analyticsService.ts`ï¼š

```typescript
import { db } from '../db/index.js';
import { promptGenerationLogs, promptTemplates } from '../db/schema.js';
import { sql, eq, and, gte } from 'drizzle-orm';

export class AnalyticsService {
  /**
   * è·å–æ¨¡æ¿æ€§èƒ½æŠ¥å‘Š
   */
  async getTemplatePerformance(
    templateId: string,
    days: number = 7
  ) {
    const since = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
    
    const stats = await db
      .select({
        totalGenerations: sql<number>`COUNT(*)`,
        avgRating: sql<number>`AVG(${promptGenerationLogs.userRating})`,
        successRate: sql<number>`
          (COUNT(CASE WHEN ${promptGenerationLogs.isSuccessful} = true THEN 1 END)::float / 
           COUNT(CASE WHEN ${promptGenerationLogs.userRating} IS NOT NULL THEN 1 END)::float * 100)`,
        avgGenerationTime: sql<number>`AVG(${promptGenerationLogs.generationTime})`,
        copyRate: sql<number>`
          (COUNT(CASE WHEN ${promptGenerationLogs.wasCopied} = true THEN 1 END)::float / 
           COUNT(*)::float * 100)`,
        saveRate: sql<number>`
          (COUNT(CASE WHEN ${promptGenerationLogs.wasSaved} = true THEN 1 END)::float / 
           COUNT(*)::float * 100)`,
        ratingDistribution: sql<any>`
          json_build_object(
            'star_1', COUNT(CASE WHEN ${promptGenerationLogs.userRating} = 1 THEN 1 END),
            'star_2', COUNT(CASE WHEN ${promptGenerationLogs.userRating} = 2 THEN 1 END),
            'star_3', COUNT(CASE WHEN ${promptGenerationLogs.userRating} = 3 THEN 1 END),
            'star_4', COUNT(CASE WHEN ${promptGenerationLogs.userRating} = 4 THEN 1 END),
            'star_5', COUNT(CASE WHEN ${promptGenerationLogs.userRating} = 5 THEN 1 END)
          )`,
      })
      .from(promptGenerationLogs)
      .where(
        and(
          eq(promptGenerationLogs.templateId, templateId),
          gte(promptGenerationLogs.createdAt, since)
        )
      );
    
    return stats[0];
  }
  
  /**
   * æ¯”è¾ƒå¤šä¸ªæ¨¡æ¿çš„æ€§èƒ½
   */
  async compareTemplates(templateIds: string[], days: number = 7) {
    const results = await Promise.all(
      templateIds.map(id => this.getTemplatePerformance(id, days))
    );
    
    return results;
  }
  
  /**
   * åˆ†ææˆåŠŸæç¤ºè¯çš„å…±åŒç‰¹å¾
   */
  async analyzeSuccessPatterns(model: string, minRating: number = 4) {
    const successfulPrompts = await db
      .select({
        outputPrompt: promptGenerationLogs.outputPrompt,
        inputIdea: promptGenerationLogs.inputIdea,
        inputStyle: promptGenerationLogs.inputStyle,
        userRating: promptGenerationLogs.userRating,
      })
      .from(promptGenerationLogs)
      .where(
        and(
          eq(promptGenerationLogs.inputModel, model),
          gte(promptGenerationLogs.userRating, minRating)
        )
      )
      .limit(100);
    
    // ä½¿ç”¨AIåˆ†æå…±åŒæ¨¡å¼
    const analysis = await this.analyzeWithAI(successfulPrompts, model);
    
    return analysis;
  }
  
  /**
   * ä½¿ç”¨AIåˆ†ææç¤ºè¯æ¨¡å¼
   */
  private async analyzeWithAI(prompts: any[], model: string) {
    const promptTexts = prompts.map(p => p.outputPrompt).join('\n\n---\n\n');
    
    const completion = await openrouter.chat.completions.create({
      model: 'anthropic/claude-3.5-sonnet',
      messages: [
        {
          role: 'system',
          content: `You are a data analyst specializing in prompt engineering.
Analyze the following high-rated ${model} prompts and identify common patterns, structures, and techniques.

Focus on:
1. Common keywords and phrases
2. Structural patterns
3. Technical parameter usage
4. Descriptive techniques
5. Effective modifiers

Provide actionable insights for improving future prompts.`
        },
        {
          role: 'user',
          content: `Here are ${prompts.length} successful prompts:\n\n${promptTexts}\n\nWhat patterns do you see?`
        }
      ],
      temperature: 0.3,
    });
    
    return completion.choices[0].message.content;
  }
  
  /**
   * ç”Ÿæˆä¼˜åŒ–å»ºè®®
   */
  async generateOptimizationSuggestions(templateId: string) {
    const performance = await this.getTemplatePerformance(templateId, 30);
    
    const suggestions = [];
    
    // åŸºäºæ€§èƒ½æ•°æ®ç”Ÿæˆå»ºè®®
    if (performance.avgRating < 3.5) {
      suggestions.push({
        type: 'low_rating',
        severity: 'high',
        message: 'å¹³å‡è¯„åˆ†è¾ƒä½ï¼Œå»ºè®®é‡æ–°å®¡è§†æç¤ºè¯ç»“æ„å’Œå†…å®¹',
      });
    }
    
    if (performance.successRate < 70) {
      suggestions.push({
        type: 'low_success',
        severity: 'high',
        message: 'æˆåŠŸç‡åä½ï¼Œå»ºè®®å¢åŠ æ›´å¤šå…·ä½“çš„æŠ€æœ¯å‚æ•°å’Œæè¿°ç»†èŠ‚',
      });
    }
    
    if (performance.avgGenerationTime > 5000) {
      suggestions.push({
        type: 'slow_generation',
        severity: 'medium',
        message: 'ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè€ƒè™‘ç®€åŒ–system promptæˆ–è°ƒæ•´æ¸©åº¦å‚æ•°',
      });
    }
    
    if (performance.copyRate < 40) {
      suggestions.push({
        type: 'low_usage',
        severity: 'medium',
        message: 'å¤åˆ¶ç‡è¾ƒä½ï¼Œç”¨æˆ·å¯èƒ½è§‰å¾—ç”Ÿæˆçš„æç¤ºè¯ä¸å¤Ÿå®ç”¨',
      });
    }
    
    return suggestions;
  }
}

export const analyticsService = new AnalyticsService();
```

#### 5.2 è‡ªåŠ¨ä¼˜åŒ–ä»»åŠ¡

`backend/src/jobs/optimizeStrategies.job.ts`ï¼š

```typescript
import cron from 'node-cron';
import { analyticsService } from '../services/analyticsService.js';
import { strategyService } from '../services/strategyService.js';
import { db } from '../db/index.js';
import { promptTemplates } from '../db/schema.js';
import { eq } from 'drizzle-orm';

/**
 * æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä¼˜åŒ–ä»»åŠ¡
 */
export function startOptimizationJob() {
  cron.schedule('0 2 * * *', async () => {
    console.log('[ä¼˜åŒ–ä»»åŠ¡] å¼€å§‹åˆ†æç­–ç•¥æ€§èƒ½...');
    
    try {
      // 1. è·å–æ‰€æœ‰æ´»è·ƒæ¨¡æ¿
      const activeTemplates = await strategyService.listTemplates({ isActive: true });
      
      for (const template of activeTemplates) {
        console.log(`[ä¼˜åŒ–ä»»åŠ¡] åˆ†ææ¨¡æ¿: ${template.name}`);
        
        // 2. è·å–æ€§èƒ½æ•°æ®
        const performance = await analyticsService.getTemplatePerformance(template.id, 7);
        
        // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦ä¼˜åŒ–
        const needsOptimization = 
          performance.avgRating < 3.5 || 
          performance.successRate < 70 ||
          performance.copyRate < 40;
        
        if (needsOptimization) {
          console.log(`[ä¼˜åŒ–ä»»åŠ¡] æ¨¡æ¿ ${template.name} éœ€è¦ä¼˜åŒ–`);
          
          // 4. åˆ†ææˆåŠŸæ¨¡å¼
          const patterns = await analyticsService.analyzeSuccessPatterns(template.model);
          
          // 5. ç”Ÿæˆä¼˜åŒ–å»ºè®®
          const suggestions = await analyticsService.generateOptimizationSuggestions(template.id);
          
          // 6. ä½¿ç”¨AIç”Ÿæˆæ”¹è¿›ç‰ˆæœ¬
          const improvedPrompt = await generateImprovedPrompt(
            template,
            patterns,
            suggestions
          );
          
          // 7. åˆ›å»ºæ–°ç‰ˆæœ¬
          const newVersion = incrementVersion(template.version);
          await strategyService.createTemplate({
            name: `${template.name} (ä¼˜åŒ–ç‰ˆ)`,
            model: template.model,
            version: newVersion,
            systemPrompt: improvedPrompt.systemPrompt,
            userPromptTemplate: improvedPrompt.userPromptTemplate,
            metadata: template.metadata,
            createdBy: 'system',
          });
          
          console.log(`[ä¼˜åŒ–ä»»åŠ¡] åˆ›å»ºæ–°ç‰ˆæœ¬: ${newVersion}`);
          
          // 8. é€šçŸ¥ç®¡ç†å‘˜
          await notifyAdmins({
            type: 'optimization_suggestion',
            template: template.name,
            performance,
            suggestions,
            newVersion,
          });
        } else {
          console.log(`[ä¼˜åŒ–ä»»åŠ¡] æ¨¡æ¿ ${template.name} è¡¨ç°è‰¯å¥½ï¼Œæ— éœ€ä¼˜åŒ–`);
        }
      }
      
      console.log('[ä¼˜åŒ–ä»»åŠ¡] å®Œæˆ');
    } catch (error) {
      console.error('[ä¼˜åŒ–ä»»åŠ¡] å¤±è´¥:', error);
    }
  });
}

/**
 * ä½¿ç”¨AIç”Ÿæˆæ”¹è¿›çš„æç¤ºè¯
 */
async function generateImprovedPrompt(
  template: any,
  patterns: string,
  suggestions: any[]
) {
  const completion = await openrouter.chat.completions.create({
    model: 'anthropic/claude-3.5-sonnet',
    messages: [
      {
        role: 'system',
        content: `You are an expert prompt engineer. Your task is to improve an existing prompt template based on:
1. Analysis of successful patterns
2. Performance data and suggestions
3. Best practices for ${template.model}

Provide improved versions of both the system prompt and user prompt template.`
      },
      {
        role: 'user',
        content: `Current template for ${template.model}:

System Prompt:
${template.systemPrompt}

User Prompt Template:
${template.userPromptTemplate}

Success Patterns Analysis:
${patterns}

Optimization Suggestions:
${suggestions.map(s => `- ${s.message}`).join('\n')}

Please provide improved versions that address these issues while maintaining the original intent.

Response format (JSON):
{
  "systemPrompt": "...",
  "userPromptTemplate": "...",
  "changes": ["list of key improvements made"]
}`
      }
    ],
    temperature: 0.7,
    response_format: { type: 'json_object' },
  });
  
  return JSON.parse(completion.choices[0].message.content || '{}');
}

/**
 * ç‰ˆæœ¬å·é€’å¢
 */
function incrementVersion(version: string): string {
  const parts = version.replace('v', '').split('.');
  const minor = parseInt(parts[1] || '0');
  return `v${parts[0]}.${minor + 1}`;
}

/**
 * é€šçŸ¥ç®¡ç†å‘˜
 */
async function notifyAdmins(data: any) {
  // å®ç°é€šçŸ¥é€»è¾‘ï¼ˆé‚®ä»¶ã€Slackã€ç³»ç»Ÿé€šçŸ¥ç­‰ï¼‰
  console.log('[é€šçŸ¥] å‘é€ä¼˜åŒ–æŠ¥å‘Šç»™ç®¡ç†å‘˜:', data);
  
  // TODO: å‘é€é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥
}
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### æ ¸å¿ƒæŒ‡æ ‡ (KPIs)

#### 1. è´¨é‡æŒ‡æ ‡

```typescript
// å¹³å‡è¯„åˆ† (ç›®æ ‡: â‰¥ 4.0)
avgRating = SUM(ratings) / COUNT(ratings)

// æˆåŠŸç‡ (ç›®æ ‡: â‰¥ 80%)
successRate = COUNT(rating >= 3) / COUNT(total_ratings) * 100

// Net Promoter Score (ç›®æ ‡: â‰¥ 50)
NPS = (COUNT(rating >= 4) - COUNT(rating <= 2)) / COUNT(total_ratings) * 100
```

#### 2. ä½¿ç”¨æŒ‡æ ‡

```typescript
// é‡‡ç”¨ç‡ (ç›®æ ‡: â‰¥ 60%)
adoptionRate = COUNT(copied_or_saved) / COUNT(total_generations) * 100

// ç•™å­˜ç‡ (ç›®æ ‡: â‰¥ 70%)
retentionRate = COUNT(users_who_returned) / COUNT(total_users) * 100
```

#### 3. æ€§èƒ½æŒ‡æ ‡

```typescript
// å¹³å‡ç”Ÿæˆæ—¶é—´ (ç›®æ ‡: â‰¤ 3ç§’)
avgGenerationTime = AVG(generation_time_ms) / 1000

// é”™è¯¯ç‡ (ç›®æ ‡: â‰¤ 1%)
errorRate = COUNT(errors) / COUNT(total_requests) * 100
```

### ç›‘æ§ä»ªè¡¨æ¿

åˆ›å»º `frontend/src/pages/admin/AnalyticsDashboard.tsx`ï¼š

```tsx
import { useState, useEffect } from 'react';
import { BarChart, LineChart, PieChart } from 'recharts';

export const AnalyticsDashboard = () => {
  const [metrics, setMetrics] = useState<any>(null);
  
  useEffect(() => {
    fetchMetrics();
  }, []);
  
  const fetchMetrics = async () => {
    const response = await fetch('/api/v1/admin/analytics/overview', {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });
    const data = await response.json();
    setMetrics(data.data);
  };
  
  return (
    <div className="p-8 space-y-8">
      <h1 className="text-3xl font-bold text-white">ç­–ç•¥æ€§èƒ½åˆ†æ</h1>
      
      {/* KPI Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <MetricCard
          title="å¹³å‡è¯„åˆ†"
          value={metrics?.avgRating.toFixed(2)}
          target={4.0}
          icon="â­"
          trend={metrics?.ratingTrend}
        />
        <MetricCard
          title="æˆåŠŸç‡"
          value={`${metrics?.successRate.toFixed(1)}%`}
          target={80}
          icon="âœ“"
          trend={metrics?.successTrend}
        />
        <MetricCard
          title="é‡‡ç”¨ç‡"
          value={`${metrics?.adoptionRate.toFixed(1)}%`}
          target={60}
          icon="ğŸ“‹"
          trend={metrics?.adoptionTrend}
        />
        <MetricCard
          title="ç”Ÿæˆæ—¶é—´"
          value={`${metrics?.avgTime.toFixed(2)}s`}
          target={3}
          icon="âš¡"
          trend={metrics?.timeTrend}
        />
      </div>
      
      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* è¯„åˆ†åˆ†å¸ƒ */}
        <div className="bg-gray-800 rounded-lg p-6">
          <h3 className="text-xl font-semibold text-white mb-4">è¯„åˆ†åˆ†å¸ƒ</h3>
          <PieChart data={metrics?.ratingDistribution} />
        </div>
        
        {/* æ¯æ—¥è¶‹åŠ¿ */}
        <div className="bg-gray-800 rounded-lg p-6">
          <h3 className="text-xl font-semibold text-white mb-4">æ¯æ—¥è¶‹åŠ¿</h3>
          <LineChart data={metrics?.dailyTrends} />
        </div>
      </div>
      
      {/* æ¨¡æ¿å¯¹æ¯” */}
      <div className="bg-gray-800 rounded-lg p-6">
        <h3 className="text-xl font-semibold text-white mb-4">æ¨¡æ¿æ€§èƒ½å¯¹æ¯”</h3>
        <BarChart data={metrics?.templateComparison} />
      </div>
    </div>
  );
};
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç­–ç•¥è®¾è®¡åŸåˆ™

#### âœ… å¥½çš„ç­–ç•¥
```typescript
const goodStrategy = {
  systemPrompt: `You are an expert Sora prompt engineer with 5+ years of experience.

Your expertise includes:
- Camera movement and cinematography
- Visual storytelling techniques  
- Technical parameters for optimal output
- Style-specific vocabulary

Guidelines:
1. Be specific and detailed
2. Include camera movements
3. Specify lighting and mood
4. Add temporal elements (duration, pacing)
5. Use industry-standard terminology`,
  
  userPromptTemplate: `Create a professional Sora video prompt:

Concept: {{idea}}
Style: {{style}}

Structure your prompt with:
1. **Shot Type**: (e.g., wide shot, close-up, aerial)
2. **Subject & Action**: What is happening
3. **Setting**: Where and when
4. **Camera Movement**: (e.g., slow pan, tracking shot)
5. **Lighting**: Time of day, quality of light
6. **Mood**: Emotional tone
7. **Duration**: Approximate length
8. **Technical**: Frame rate, aspect ratio if relevant

Output a single, cohesive prompt ready to use.`,
};
```

#### âŒ å·®çš„ç­–ç•¥
```typescript
const badStrategy = {
  systemPrompt: `You are a prompt generator.`,
  userPromptTemplate: `Make a prompt for {{idea}} in {{style}} style.`,
};
```

**åŸå› **ï¼š
- ç¼ºä¹å…·ä½“æŒ‡å¯¼
- æ²¡æœ‰ç»“æ„åŒ–è¾“å‡º
- ç¼ºå°‘ä¸“ä¸šæœ¯è¯­
- æ²¡æœ‰è´¨é‡æ§åˆ¶

### 2. A/Bæµ‹è¯•æœ€ä½³å®è·µ

#### æµ‹è¯•ä»€ä¹ˆï¼Ÿ
- âœ… ä¸åŒçš„system promptç»“æ„
- âœ… ç”¨æˆ·æç¤ºè¯æ¨¡æ¿çš„å˜åŒ–
- âœ… æ¸©åº¦å’Œå…¶ä»–å‚æ•°
- âœ… è¾“å‡ºæ ¼å¼ï¼ˆç»“æ„åŒ– vs è‡ªç”±æ–‡æœ¬ï¼‰

#### ä½•æ—¶ç»“æŸæµ‹è¯•ï¼Ÿ
```typescript
// è¾¾åˆ°ç»Ÿè®¡æ˜¾è‘—æ€§
const minSampleSize = 100; // æ¯ç»„è‡³å°‘100ä¸ªæ ·æœ¬
const minPValue = 0.05;    // på€¼å°äº0.05

if (
  samples >= minSampleSize && 
  pValue < minPValue &&
  Math.abs(improvement) > 5 // è‡³å°‘5%çš„æå‡
) {
  // å¯ä»¥ç»“æŸæµ‹è¯•å¹¶é‡‡ç”¨èµ¢å®¶
}
```

### 3. æ•°æ®æ”¶é›†å»ºè®®

#### å¿…é¡»æ”¶é›†çš„æ•°æ®
- âœ… ç”¨æˆ·è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰
- âœ… æˆåŠŸ/å¤±è´¥æ ‡è®°
- âœ… å¤åˆ¶å’Œä¿å­˜è¡Œä¸º
- âœ… ç”Ÿæˆæ—¶é—´
- âœ… Tokenä½¿ç”¨é‡

#### å¯é€‰ä½†æœ‰ç”¨çš„æ•°æ®
- ç”¨æˆ·è®¾å¤‡å’Œæµè§ˆå™¨
- åœ°ç†ä½ç½®ï¼ˆç”¨äºæœ¬åœ°åŒ–ï¼‰
- ä¼šè¯æ—¶é•¿
- è¿”å›é¢‘ç‡

### 4. éšç§å’Œåˆè§„

```typescript
// æ•°æ®è„±æ•
function anonymizeData(log: any) {
  return {
    ...log,
    userId: hashUserId(log.userId), // å“ˆå¸Œå¤„ç†
    ipAddress: null,                 // ç§»é™¤IP
    userAgent: genericizeUserAgent(log.userAgent),
  };
}

// GDPRåˆè§„ï¼šå…è®¸ç”¨æˆ·åˆ é™¤æ•°æ®
async function deleteUserData(userId: string) {
  await db.delete(promptGenerationLogs)
    .where(eq(promptGenerationLogs.userId, userId));
}
```

---

## ğŸš€ è¿›é˜¶ä¼˜åŒ–

### 1. æœºå™¨å­¦ä¹ é©±åŠ¨

ä½¿ç”¨å†å²æ•°æ®è®­ç»ƒæ¨¡å‹ï¼Œé¢„æµ‹æœ€ä½³ç­–ç•¥ï¼š

```python
# Pythonè„šæœ¬ - è®­ç»ƒé¢„æµ‹æ¨¡å‹
import pandas as pd
from sklearn.ensemble import RandomForestClassifier

# åŠ è½½æ•°æ®
data = pd.read_sql("SELECT * FROM prompt_generation_logs", conn)

# ç‰¹å¾å·¥ç¨‹
features = [
    'input_length',
    'has_technical_terms',
    'structure_score',
    'keyword_density',
    'model_type',
]

X = data[features]
y = (data['user_rating'] >= 4).astype(int)  # æˆåŠŸ = è¯„åˆ†â‰¥4

# è®­ç»ƒæ¨¡å‹
model = RandomForestClassifier()
model.fit(X, y)

# é¢„æµ‹æ–°ç­–ç•¥çš„è¡¨ç°
prediction = model.predict_proba(new_strategy_features)
```

### 2. ä¸ªæ€§åŒ–æ¨è

æ ¹æ®ç”¨æˆ·å†å²åå¥½å®šåˆ¶ç­–ç•¥ï¼š

```typescript
async function getPersonalizedTemplate(userId: string, model: string) {
  // åˆ†æç”¨æˆ·å†å²
  const userHistory = await db
    .select()
    .from(promptGenerationLogs)
    .where(eq(promptGenerationLogs.userId, userId))
    .orderBy(desc(promptGenerationLogs.userRating))
    .limit(20);
  
  // è¯†åˆ«ç”¨æˆ·åå¥½
  const preferences = analyzePreferences(userHistory);
  
  // é€‰æ‹©åŒ¹é…çš„æ¨¡æ¿
  return selectTemplateByPreferences(model, preferences);
}
```

### 3. å®æ—¶ä¼˜åŒ–

åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´ï¼š

```typescript
async function generateWithRealTimeOptimization(
  idea: string,
  model: string,
  style: string
) {
  // ç¬¬ä¸€æ¬¡ç”Ÿæˆ
  let prompt = await generatePrompt(idea, model, style);
  
  // å¿«é€Ÿè´¨é‡è¯„ä¼°
  const quality = await assessQuality(prompt);
  
  // å¦‚æœè´¨é‡ä¸ä½³ï¼Œå°è¯•ä¼˜åŒ–
  if (quality < 0.7) {
    prompt = await optimizePrompt(prompt, model);
  }
  
  return prompt;
}
```

---

## ğŸ“š æ€»ç»“

### å®æ–½è·¯çº¿å›¾

```
Week 1-2:  âœ… åŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ã€æ—¥å¿—ï¼‰
Week 3-4:  âœ… ç­–ç•¥ç®¡ç†ç³»ç»Ÿ
Week 5-6:  âœ… ç”¨æˆ·åé¦ˆç³»ç»Ÿ
Week 7-8:  âœ… A/Bæµ‹è¯•æ¡†æ¶
Week 9-10: âœ… æ•°æ®åˆ†æå’Œè‡ªåŠ¨ä¼˜åŒ–
Week 11+:  ğŸš€ æŒç»­è¿­ä»£å’Œæ”¹è¿›
```

### é¢„æœŸæˆæœ

- ğŸ“ˆ **æç¤ºè¯è´¨é‡æå‡**: å¹³å‡è¯„åˆ†ä»3.5æå‡è‡³4.2+
- ğŸ“ˆ **ç”¨æˆ·æ»¡æ„åº¦æå‡**: NPSä»30æå‡è‡³60+
- ğŸ“ˆ **é‡‡ç”¨ç‡æå‡**: ä»40%æå‡è‡³70%+
- ğŸ“‰ **ç”Ÿæˆæ—¶é—´é™ä½**: ä»5ç§’é™è‡³2ç§’ä»¥å†…
- ğŸ¤– **è‡ªåŠ¨åŒ–è¿ç»´**: 90%çš„ä¼˜åŒ–å·¥ä½œè‡ªåŠ¨å®Œæˆ

### æŒç»­æ”¹è¿›

è¿™ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯**æŒç»­å­¦ä¹ å’Œè¿­ä»£**ï¼š

1. **æ¯æ—¥**: è‡ªåŠ¨æ”¶é›†æ•°æ®å’Œç›‘æ§æŒ‡æ ‡
2. **æ¯å‘¨**: åˆ†ææ€§èƒ½è¶‹åŠ¿ï¼Œè¯†åˆ«é—®é¢˜
3. **æ¯æœˆ**: A/Bæµ‹è¯•æ–°ç­–ç•¥ï¼Œé‡‡ç”¨èµ¢å®¶
4. **æ¯å­£åº¦**: é‡å¤§ç­–ç•¥å‡çº§ï¼Œå¼•å…¥æ–°æŠ€æœ¯

---

**æ–‡æ¡£ç»´æŠ¤**: éšç€ç³»ç»Ÿæ¼”è¿›æŒç»­æ›´æ–°  
**åé¦ˆ**: æ¬¢è¿å›¢é˜Ÿæˆå‘˜æå‡ºæ”¹è¿›å»ºè®®

---

*ç‰ˆæƒæ‰€æœ‰ Â© 2025 PromptValar Team*

