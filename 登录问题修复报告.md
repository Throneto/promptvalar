# 登录问题修复报告

## 问题描述

前端登录时返回 500 Internal Server Error 错误：
```
POST https://api.promptvalar.com/api/v1/auth/login 500 (Internal Server Error)
```

## 根本原因

1. **端口被占用**: 后端服务端口 5000 被旧进程占用，导致新的后端服务无法启动
2. **环境变量缺失**: `.env` 文件缺少 `JWT_REFRESH_SECRET` 环境变量
3. **环境变量未正确加载**: 在后台启动时，环境变量没有被正确加载

## 已执行的修复

### 1. 清理旧进程
```bash
# 杀掉占用端口 5000 的进程
kill -9 437766
```

### 2. 添加缺失的环境变量
在 `/root/promptvalar/backend/.env` 中添加：
```
JWT_REFRESH_SECRET=your-super-secret-jwt-refresh-key-change-this-in-production-2024
```

### 3. 使用正确的环境变量重启后端
```bash
cd /root/promptvalar/backend
DATABASE_URL="postgresql://promptvalar:throne999000@localhost:5432/promptvalar" \
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production-2024" \
JWT_REFRESH_SECRET="your-super-secret-jwt-refresh-key-change-this-in-production-2024" \
NODE_ENV=development \
npm run dev > backend.log 2>&1 &
```

### 4. 创建启动脚本
创建了 `/root/promptvalar/backend/start-backend.sh` 脚本，确保每次启动时正确加载环境变量。

### 5. 重启Nginx服务
```bash
systemctl reload nginx
```
确保nginx正确代理到后端服务。

### 6. 测试账号设置
为测试方便，已为以下账号设置密码：

| 邮箱 | 密码 | 角色 | 订阅级别 |
|------|------|------|----------|
| test@example.com | Test123456 | user | free |
| test@tablevision.top | Test123456 | admin | pro |

## 验证结果

✅ 后端服务正常运行在端口 5000
✅ 本地登录 API 返回正确响应（200 成功，401 认证失败）
✅ 生产环境 HTTPS API 正常工作
✅ 测试账号可以正常登录并返回 JWT token
✅ SSL证书包含 api.promptvalar.com 和 promptvalar.com 域名
✅ Nginx 正确代理请求到后端服务

### 测试示例

#### 本地环境测试
```bash
# 测试登录
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@tablevision.top","password":"Test123456"}'
```

#### 生产环境测试
```bash
# 测试登录（HTTPS）
curl -X POST https://api.promptvalar.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@tablevision.top","password":"Test123456"}'
```

#### 返回结果示例
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "8f1fb68c-9817-49cc-9fed-7838f310581f",
      "username": "testuser",
      "email": "test@tablevision.top",
      "role": "admin",
      "subscriptionTier": "pro"
    },
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

## 后续建议

1. **生产环境安全**: 在部署到生产环境前，请更换所有 JWT 密钥为强随机字符串
2. **环境变量管理**: 确保 `.env` 文件包含所有必需的环境变量
3. **进程管理**: 建议使用 PM2 或其他进程管理工具来管理后端服务
4. **日志监控**: 定期检查 `backend.log` 以发现潜在问题

## 使用说明

### 启动后端服务
```bash
# 方式1: 使用启动脚本（推荐）
/root/promptvalar/backend/start-backend.sh

# 方式2: 手动启动
cd /root/promptvalar/backend
npm run dev
```

### 停止后端服务
```bash
# 查找进程
lsof -i :5000

# 停止进程（替换 PID）
kill -9 <PID>
```

### 查看日志
```bash
tail -f /root/promptvalar/backend/backend.log
```

---

**修复时间**: 2025-10-28 15:12
**状态**: ✅ 已解决

