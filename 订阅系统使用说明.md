# 🎉 PromptValar 订阅系统使用说明

恭喜！订阅系统已经完整实现并可以使用了！

---

## ✅ 已完成的功能

### 后端 Backend
- ✅ Stripe 支付集成
- ✅ 订阅服务层（600+ 行代码）
- ✅ 订阅控制器和 API 端点
- ✅ 订阅验证中间件
- ✅ Webhook 事件处理
- ✅ **测试模式支持**（无需真实 Stripe 账号）

### 前端 Frontend
- ✅ 精美的定价页面 `/pricing`
- ✅ 订阅管理页面 `/dashboard/subscription`
- ✅ Stripe Checkout 集成
- ✅ 实时状态更新
- ✅ 取消/恢复订阅功能

### 文档和测试
- ✅ 完整使用指南（SUBSCRIPTION_GUIDE.md）
- ✅ 快速开始指南（SUBSCRIPTION_SETUP.md）
- ✅ 自动化测试脚本（test-subscription.js）
- ✅ 完成报告（PHASE4_COMPLETION_REPORT.md）

---

## 🚀 快速开始（5分钟）

### 方式 1: 使用测试模式（推荐，无需 Stripe 账号）

#### 1. 配置环境变量

在 `backend/.env` 文件中添加：

```bash
# 启用测试模式
STRIPE_TEST_MODE=true

# 这些可以使用占位符
STRIPE_SECRET_KEY=sk_test_placeholder
STRIPE_WEBHOOK_SECRET=whsec_test_placeholder
STRIPE_PRO_PRICE_ID=price_test_pro
```

#### 2. 运行数据库迁移

```bash
cd backend
npm run db:migrate
```

#### 3. 启动服务

```bash
# 终端 1 - 后端
cd backend
npm run dev

# 终端 2 - 前端  
cd frontend
npm run dev
```

#### 4. 测试订阅功能

**选项 A: 通过网页界面**
1. 打开浏览器访问 `http://localhost:5173`
2. 注册/登录账号
3. 访问 `/pricing` 定价页面
4. 点击"升级到 Pro"
5. 系统会自动激活 Pro 订阅（测试模式）
6. 访问 `/dashboard/subscription` 查看订阅状态

**选项 B: 运行测试脚本**
```bash
node test-subscription.js
```

测试脚本会自动测试所有订阅功能并显示详细结果。

---

## 🧪 测试模式特点

### 优势
- ✅ **无需 Stripe 账号** - 可以立即开始测试
- ✅ **一键激活** - 点击按钮即可激活 Pro
- ✅ **完整功能** - 所有订阅功能都可测试
- ✅ **快速迭代** - 适合开发和演示

### 测试流程
1. **查看定价** → 访问 `/pricing`
2. **升级到 Pro** → 点击按钮
3. **自动激活** → 无需支付
4. **管理订阅** → `/dashboard/subscription`
5. **取消/恢复** → 测试完整流程

### 页面截图位置
- 定价页面有明显的"🧪 测试模式"提示
- 订阅管理页面显示测试模式状态
- 所有操作都会显示 `testMode: true`

---

## 💳 切换到生产模式

当你准备好使用真实支付时：

### 1. 注册 Stripe 账号
访问 https://stripe.com 注册

### 2. 获取 API 密钥
在 Stripe Dashboard → 开发者 → API 密钥

### 3. 创建产品和价格
在 Stripe Dashboard → 产品 → 添加产品
- 名称: PromptValar Pro
- 价格: ¥19.99/月
- 复制 Price ID

### 4. 配置 Webhook
在 Stripe Dashboard → 开发者 → Webhooks
- URL: `https://your-domain.com/api/v1/subscriptions/webhook`
- 选择事件: checkout.session.completed, customer.subscription.*

### 5. 更新环境变量

```bash
# backend/.env
STRIPE_TEST_MODE=false
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_PRO_PRICE_ID=price_xxx
```

### 6. 重启服务并测试

详细步骤请参考 `SUBSCRIPTION_GUIDE.md`

---

## 📊 订阅计划

### Free 计划（免费）
- 每月 20 次 AI 生成
- 访问基础提示词库
- 基础模型支持
- 社区支持

### Pro 计划（¥19.99/月）
- ✨ 无限次 AI 生成
- ✨ 访问所有高级提示词
- ✨ 所有 AI 模型支持
- ✨ 优先客户支持
- ✨ 高级编辑器功能
- ✨ 提示词历史记录
- ✨ API 访问权限

---

## 🛠 技术架构

### API 端点

```
GET  /api/v1/subscriptions/plans          # 获取订阅计划
GET  /api/v1/subscriptions/current        # 获取当前订阅
POST /api/v1/subscriptions/checkout       # 创建 Checkout
POST /api/v1/subscriptions/portal         # 创建 Portal
POST /api/v1/subscriptions/cancel         # 取消订阅
POST /api/v1/subscriptions/resume         # 恢复订阅
POST /api/v1/subscriptions/webhook        # Stripe Webhook
POST /api/v1/subscriptions/test/activate  # 测试模式激活
```

### 中间件

```typescript
// 保护 Pro 功能
import { requireProSubscription } from './middleware/subscription.middleware';

router.get('/pro-feature', 
  authenticate, 
  requireProSubscription, 
  handler
);

// 功能访问控制
import { requireFeatureAccess } from './middleware/subscription.middleware';

router.post('/advanced-feature',
  authenticate,
  requireFeatureAccess('premium-prompts'),
  handler
);
```

---

## 📝 文件结构

```
backend/src/
├── services/
│   └── subscription.service.ts      # 订阅业务逻辑
├── controllers/
│   └── subscription.controller.ts   # API 端点
├── middleware/
│   └── subscription.middleware.ts   # 访问控制
└── routes/
    └── subscription.routes.ts       # 路由配置

frontend/src/
├── pages/
│   ├── PricingPage.tsx              # 定价页面
│   └── SubscriptionManagementPage.tsx # 订阅管理
└── services/
    └── subscription.ts              # API 服务

根目录/
├── SUBSCRIPTION_GUIDE.md            # 完整指南
├── SUBSCRIPTION_SETUP.md            # 快速开始
├── PHASE4_COMPLETION_REPORT.md      # 完成报告
└── test-subscription.js             # 测试脚本
```

---

## 🔍 常见问题

### Q: 测试模式下可以测试所有功能吗？
**A:** 是的！测试模式支持完整的订阅功能，包括：
- 订阅激活/取消/恢复
- 功能访问控制
- 订阅状态管理
- UI 交互流程

### Q: 如何在测试模式下激活 Pro 订阅？
**A:** 两种方式：
1. 访问 `/pricing` 页面，点击"升级到 Pro"
2. 使用 API: `POST /api/v1/subscriptions/test/activate`

### Q: 测试模式和生产模式有什么区别？
**A:** 
- **测试模式**: 跳过 Stripe API，使用模拟数据
- **生产模式**: 真实 Stripe 集成，真实支付

### Q: 如何切换到生产模式？
**A:** 
1. 获取 Stripe 生产密钥
2. 设置 `STRIPE_TEST_MODE=false`
3. 配置真实的 Price ID 和 Webhook
4. 重启服务

### Q: 出现问题如何排查？
**A:** 
1. 检查环境变量配置
2. 查看后端日志
3. 运行 `test-subscription.js` 诊断
4. 参考 `SUBSCRIPTION_GUIDE.md` 的问题排查部分

---

## 📚 详细文档

- **SUBSCRIPTION_GUIDE.md** - 5000+ 字完整指南
  - 系统概述
  - 技术架构
  - API 文档
  - 测试指南
  - 常见问题

- **SUBSCRIPTION_SETUP.md** - 3000+ 字快速开始
  - 5分钟开始
  - 环境配置
  - 测试清单
  - 问题排查

- **PHASE4_COMPLETION_REPORT.md** - 完成报告
  - 功能清单
  - 代码统计
  - 技术亮点
  - 测试验证

---

## ✨ 使用示例

### 前端代码示例

```typescript
import { 
  createCheckoutSession,
  getCurrentSubscription,
  cancelSubscription 
} from '../services/subscription';

// 创建订阅
const handleSubscribe = async () => {
  const { url, testMode } = await createCheckoutSession(token, priceId);
  
  if (testMode) {
    // 测试模式：订阅已自动激活
    alert('Pro 订阅已激活！');
  } else {
    // 生产模式：跳转到 Stripe
    window.location.href = url;
  }
};

// 获取订阅状态
const subscription = await getCurrentSubscription(token);
console.log('订阅状态:', subscription?.status);

// 取消订阅
await cancelSubscription(token, false);
```

### 后端中间件示例

```typescript
// 保护 Pro 功能
app.get('/api/v1/premium-prompts',
  authenticate,
  requireProSubscription,
  async (req, res) => {
    // 只有 Pro 用户才能访问
    const prompts = await getPremiumPrompts();
    res.json(prompts);
  }
);

// 特性级别控制
app.post('/api/v1/advanced-generate',
  authenticate,
  requireFeatureAccess('advanced-models'),
  async (req, res) => {
    // 检查是否有权使用高级模型
    const result = await generateWithAdvancedModel(req.body);
    res.json(result);
  }
);
```

---

## 🎯 下一步

### 立即可做
- ✅ 测试所有订阅功能
- ✅ 自定义订阅计划
- ✅ 调整 UI 样式
- ✅ 添加更多功能访问控制

### 准备上线时
- 📝 注册 Stripe 账号
- 📝 配置生产密钥
- 📝 设置 Webhook
- 📝 测试支付流程

### 后续优化
- 📈 添加年付折扣
- 📈 实现优惠券系统
- 📈 添加订阅分析
- 📈 邮件通知功能

---

## 💡 小贴士

1. **开发阶段**: 保持 `STRIPE_TEST_MODE=true`，快速迭代
2. **测试脚本**: 经常运行 `test-subscription.js` 验证功能
3. **查看日志**: 后端会输出详细的订阅操作日志
4. **数据库查询**: 使用 SQL 查看订阅状态
   ```sql
   SELECT u.username, u.subscription_tier, s.status 
   FROM users u 
   LEFT JOIN subscriptions s ON u.id = s.user_id;
   ```

---

## 🎉 完成！

订阅系统已经完整实现并可以立即使用！

**立即开始**:
```bash
# 1. 确保测试模式已启用
echo "STRIPE_TEST_MODE=true" >> backend/.env

# 2. 启动服务
cd backend && npm run dev
cd frontend && npm run dev

# 3. 访问定价页面
# http://localhost:5173/pricing

# 4. 开始测试！
```

**需要帮助？**
- 查看 `SUBSCRIPTION_GUIDE.md`
- 运行 `test-subscription.js`
- 检查后端日志

**祝你使用愉快！** 🚀

---

*最后更新: 2025-10-26*  
*版本: 1.0.0*

