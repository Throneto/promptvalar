# ğŸ‰ PromptValar è®¢é˜…ç³»ç»Ÿä½¿ç”¨è¯´æ˜

æ­å–œï¼è®¢é˜…ç³»ç»Ÿå·²ç»å®Œæ•´å®ç°å¹¶å¯ä»¥ä½¿ç”¨äº†ï¼

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### åç«¯ Backend
- âœ… Stripe æ”¯ä»˜é›†æˆ
- âœ… è®¢é˜…æœåŠ¡å±‚ï¼ˆ600+ è¡Œä»£ç ï¼‰
- âœ… è®¢é˜…æ§åˆ¶å™¨å’Œ API ç«¯ç‚¹
- âœ… è®¢é˜…éªŒè¯ä¸­é—´ä»¶
- âœ… Webhook äº‹ä»¶å¤„ç†
- âœ… **æµ‹è¯•æ¨¡å¼æ”¯æŒ**ï¼ˆæ— éœ€çœŸå® Stripe è´¦å·ï¼‰

### å‰ç«¯ Frontend
- âœ… ç²¾ç¾çš„å®šä»·é¡µé¢ `/pricing`
- âœ… è®¢é˜…ç®¡ç†é¡µé¢ `/dashboard/subscription`
- âœ… Stripe Checkout é›†æˆ
- âœ… å®æ—¶çŠ¶æ€æ›´æ–°
- âœ… å–æ¶ˆ/æ¢å¤è®¢é˜…åŠŸèƒ½

### æ–‡æ¡£å’Œæµ‹è¯•
- âœ… å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ˆSUBSCRIPTION_GUIDE.mdï¼‰
- âœ… å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆSUBSCRIPTION_SETUP.mdï¼‰
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼ˆtest-subscription.jsï¼‰
- âœ… å®ŒæˆæŠ¥å‘Šï¼ˆPHASE4_COMPLETION_REPORT.mdï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿï¼‰

### æ–¹å¼ 1: ä½¿ç”¨æµ‹è¯•æ¨¡å¼ï¼ˆæ¨èï¼Œæ— éœ€ Stripe è´¦å·ï¼‰

#### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `backend/.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# å¯ç”¨æµ‹è¯•æ¨¡å¼
STRIPE_TEST_MODE=true

# è¿™äº›å¯ä»¥ä½¿ç”¨å ä½ç¬¦
STRIPE_SECRET_KEY=sk_test_placeholder
STRIPE_WEBHOOK_SECRET=whsec_test_placeholder
STRIPE_PRO_PRICE_ID=price_test_pro
```

#### 2. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend
npm run db:migrate
```

#### 3. å¯åŠ¨æœåŠ¡

```bash
# ç»ˆç«¯ 1 - åç«¯
cd backend
npm run dev

# ç»ˆç«¯ 2 - å‰ç«¯  
cd frontend
npm run dev
```

#### 4. æµ‹è¯•è®¢é˜…åŠŸèƒ½

**é€‰é¡¹ A: é€šè¿‡ç½‘é¡µç•Œé¢**
1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:5173`
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. è®¿é—® `/pricing` å®šä»·é¡µé¢
4. ç‚¹å‡»"å‡çº§åˆ° Pro"
5. ç³»ç»Ÿä¼šè‡ªåŠ¨æ¿€æ´» Pro è®¢é˜…ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
6. è®¿é—® `/dashboard/subscription` æŸ¥çœ‹è®¢é˜…çŠ¶æ€

**é€‰é¡¹ B: è¿è¡Œæµ‹è¯•è„šæœ¬**
```bash
node test-subscription.js
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨æµ‹è¯•æ‰€æœ‰è®¢é˜…åŠŸèƒ½å¹¶æ˜¾ç¤ºè¯¦ç»†ç»“æœã€‚

---

## ğŸ§ª æµ‹è¯•æ¨¡å¼ç‰¹ç‚¹

### ä¼˜åŠ¿
- âœ… **æ— éœ€ Stripe è´¦å·** - å¯ä»¥ç«‹å³å¼€å§‹æµ‹è¯•
- âœ… **ä¸€é”®æ¿€æ´»** - ç‚¹å‡»æŒ‰é’®å³å¯æ¿€æ´» Pro
- âœ… **å®Œæ•´åŠŸèƒ½** - æ‰€æœ‰è®¢é˜…åŠŸèƒ½éƒ½å¯æµ‹è¯•
- âœ… **å¿«é€Ÿè¿­ä»£** - é€‚åˆå¼€å‘å’Œæ¼”ç¤º

### æµ‹è¯•æµç¨‹
1. **æŸ¥çœ‹å®šä»·** â†’ è®¿é—® `/pricing`
2. **å‡çº§åˆ° Pro** â†’ ç‚¹å‡»æŒ‰é’®
3. **è‡ªåŠ¨æ¿€æ´»** â†’ æ— éœ€æ”¯ä»˜
4. **ç®¡ç†è®¢é˜…** â†’ `/dashboard/subscription`
5. **å–æ¶ˆ/æ¢å¤** â†’ æµ‹è¯•å®Œæ•´æµç¨‹

### é¡µé¢æˆªå›¾ä½ç½®
- å®šä»·é¡µé¢æœ‰æ˜æ˜¾çš„"ğŸ§ª æµ‹è¯•æ¨¡å¼"æç¤º
- è®¢é˜…ç®¡ç†é¡µé¢æ˜¾ç¤ºæµ‹è¯•æ¨¡å¼çŠ¶æ€
- æ‰€æœ‰æ“ä½œéƒ½ä¼šæ˜¾ç¤º `testMode: true`

---

## ğŸ’³ åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼

å½“ä½ å‡†å¤‡å¥½ä½¿ç”¨çœŸå®æ”¯ä»˜æ—¶ï¼š

### 1. æ³¨å†Œ Stripe è´¦å·
è®¿é—® https://stripe.com æ³¨å†Œ

### 2. è·å– API å¯†é’¥
åœ¨ Stripe Dashboard â†’ å¼€å‘è€… â†’ API å¯†é’¥

### 3. åˆ›å»ºäº§å“å’Œä»·æ ¼
åœ¨ Stripe Dashboard â†’ äº§å“ â†’ æ·»åŠ äº§å“
- åç§°: PromptValar Pro
- ä»·æ ¼: Â¥19.99/æœˆ
- å¤åˆ¶ Price ID

### 4. é…ç½® Webhook
åœ¨ Stripe Dashboard â†’ å¼€å‘è€… â†’ Webhooks
- URL: `https://your-domain.com/api/v1/subscriptions/webhook`
- é€‰æ‹©äº‹ä»¶: checkout.session.completed, customer.subscription.*

### 5. æ›´æ–°ç¯å¢ƒå˜é‡

```bash
# backend/.env
STRIPE_TEST_MODE=false
STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_PRO_PRICE_ID=price_xxx
```

### 6. é‡å¯æœåŠ¡å¹¶æµ‹è¯•

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ `SUBSCRIPTION_GUIDE.md`

---

## ğŸ“Š è®¢é˜…è®¡åˆ’

### Free è®¡åˆ’ï¼ˆå…è´¹ï¼‰
- æ¯æœˆ 20 æ¬¡ AI ç”Ÿæˆ
- è®¿é—®åŸºç¡€æç¤ºè¯åº“
- åŸºç¡€æ¨¡å‹æ”¯æŒ
- ç¤¾åŒºæ”¯æŒ

### Pro è®¡åˆ’ï¼ˆÂ¥19.99/æœˆï¼‰
- âœ¨ æ— é™æ¬¡ AI ç”Ÿæˆ
- âœ¨ è®¿é—®æ‰€æœ‰é«˜çº§æç¤ºè¯
- âœ¨ æ‰€æœ‰ AI æ¨¡å‹æ”¯æŒ
- âœ¨ ä¼˜å…ˆå®¢æˆ·æ”¯æŒ
- âœ¨ é«˜çº§ç¼–è¾‘å™¨åŠŸèƒ½
- âœ¨ æç¤ºè¯å†å²è®°å½•
- âœ¨ API è®¿é—®æƒé™

---

## ğŸ›  æŠ€æœ¯æ¶æ„

### API ç«¯ç‚¹

```
GET  /api/v1/subscriptions/plans          # è·å–è®¢é˜…è®¡åˆ’
GET  /api/v1/subscriptions/current        # è·å–å½“å‰è®¢é˜…
POST /api/v1/subscriptions/checkout       # åˆ›å»º Checkout
POST /api/v1/subscriptions/portal         # åˆ›å»º Portal
POST /api/v1/subscriptions/cancel         # å–æ¶ˆè®¢é˜…
POST /api/v1/subscriptions/resume         # æ¢å¤è®¢é˜…
POST /api/v1/subscriptions/webhook        # Stripe Webhook
POST /api/v1/subscriptions/test/activate  # æµ‹è¯•æ¨¡å¼æ¿€æ´»
```

### ä¸­é—´ä»¶

```typescript
// ä¿æŠ¤ Pro åŠŸèƒ½
import { requireProSubscription } from './middleware/subscription.middleware';

router.get('/pro-feature', 
  authenticate, 
  requireProSubscription, 
  handler
);

// åŠŸèƒ½è®¿é—®æ§åˆ¶
import { requireFeatureAccess } from './middleware/subscription.middleware';

router.post('/advanced-feature',
  authenticate,
  requireFeatureAccess('premium-prompts'),
  handler
);
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ subscription.service.ts      # è®¢é˜…ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ subscription.controller.ts   # API ç«¯ç‚¹
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ subscription.middleware.ts   # è®¿é—®æ§åˆ¶
â””â”€â”€ routes/
    â””â”€â”€ subscription.routes.ts       # è·¯ç”±é…ç½®

frontend/src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ PricingPage.tsx              # å®šä»·é¡µé¢
â”‚   â””â”€â”€ SubscriptionManagementPage.tsx # è®¢é˜…ç®¡ç†
â””â”€â”€ services/
    â””â”€â”€ subscription.ts              # API æœåŠ¡

æ ¹ç›®å½•/
â”œâ”€â”€ SUBSCRIPTION_GUIDE.md            # å®Œæ•´æŒ‡å—
â”œâ”€â”€ SUBSCRIPTION_SETUP.md            # å¿«é€Ÿå¼€å§‹
â”œâ”€â”€ PHASE4_COMPLETION_REPORT.md      # å®ŒæˆæŠ¥å‘Š
â””â”€â”€ test-subscription.js             # æµ‹è¯•è„šæœ¬
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q: æµ‹è¯•æ¨¡å¼ä¸‹å¯ä»¥æµ‹è¯•æ‰€æœ‰åŠŸèƒ½å—ï¼Ÿ
**A:** æ˜¯çš„ï¼æµ‹è¯•æ¨¡å¼æ”¯æŒå®Œæ•´çš„è®¢é˜…åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- è®¢é˜…æ¿€æ´»/å–æ¶ˆ/æ¢å¤
- åŠŸèƒ½è®¿é—®æ§åˆ¶
- è®¢é˜…çŠ¶æ€ç®¡ç†
- UI äº¤äº’æµç¨‹

### Q: å¦‚ä½•åœ¨æµ‹è¯•æ¨¡å¼ä¸‹æ¿€æ´» Pro è®¢é˜…ï¼Ÿ
**A:** ä¸¤ç§æ–¹å¼ï¼š
1. è®¿é—® `/pricing` é¡µé¢ï¼Œç‚¹å‡»"å‡çº§åˆ° Pro"
2. ä½¿ç”¨ API: `POST /api/v1/subscriptions/test/activate`

### Q: æµ‹è¯•æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A:** 
- **æµ‹è¯•æ¨¡å¼**: è·³è¿‡ Stripe APIï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- **ç”Ÿäº§æ¨¡å¼**: çœŸå® Stripe é›†æˆï¼ŒçœŸå®æ”¯ä»˜

### Q: å¦‚ä½•åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ï¼Ÿ
**A:** 
1. è·å– Stripe ç”Ÿäº§å¯†é’¥
2. è®¾ç½® `STRIPE_TEST_MODE=false`
3. é…ç½®çœŸå®çš„ Price ID å’Œ Webhook
4. é‡å¯æœåŠ¡

### Q: å‡ºç°é—®é¢˜å¦‚ä½•æ’æŸ¥ï¼Ÿ
**A:** 
1. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
2. æŸ¥çœ‹åç«¯æ—¥å¿—
3. è¿è¡Œ `test-subscription.js` è¯Šæ–­
4. å‚è€ƒ `SUBSCRIPTION_GUIDE.md` çš„é—®é¢˜æ’æŸ¥éƒ¨åˆ†

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **SUBSCRIPTION_GUIDE.md** - 5000+ å­—å®Œæ•´æŒ‡å—
  - ç³»ç»Ÿæ¦‚è¿°
  - æŠ€æœ¯æ¶æ„
  - API æ–‡æ¡£
  - æµ‹è¯•æŒ‡å—
  - å¸¸è§é—®é¢˜

- **SUBSCRIPTION_SETUP.md** - 3000+ å­—å¿«é€Ÿå¼€å§‹
  - 5åˆ†é’Ÿå¼€å§‹
  - ç¯å¢ƒé…ç½®
  - æµ‹è¯•æ¸…å•
  - é—®é¢˜æ’æŸ¥

- **PHASE4_COMPLETION_REPORT.md** - å®ŒæˆæŠ¥å‘Š
  - åŠŸèƒ½æ¸…å•
  - ä»£ç ç»Ÿè®¡
  - æŠ€æœ¯äº®ç‚¹
  - æµ‹è¯•éªŒè¯

---

## âœ¨ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯ä»£ç ç¤ºä¾‹

```typescript
import { 
  createCheckoutSession,
  getCurrentSubscription,
  cancelSubscription 
} from '../services/subscription';

// åˆ›å»ºè®¢é˜…
const handleSubscribe = async () => {
  const { url, testMode } = await createCheckoutSession(token, priceId);
  
  if (testMode) {
    // æµ‹è¯•æ¨¡å¼ï¼šè®¢é˜…å·²è‡ªåŠ¨æ¿€æ´»
    alert('Pro è®¢é˜…å·²æ¿€æ´»ï¼');
  } else {
    // ç”Ÿäº§æ¨¡å¼ï¼šè·³è½¬åˆ° Stripe
    window.location.href = url;
  }
};

// è·å–è®¢é˜…çŠ¶æ€
const subscription = await getCurrentSubscription(token);
console.log('è®¢é˜…çŠ¶æ€:', subscription?.status);

// å–æ¶ˆè®¢é˜…
await cancelSubscription(token, false);
```

### åç«¯ä¸­é—´ä»¶ç¤ºä¾‹

```typescript
// ä¿æŠ¤ Pro åŠŸèƒ½
app.get('/api/v1/premium-prompts',
  authenticate,
  requireProSubscription,
  async (req, res) => {
    // åªæœ‰ Pro ç”¨æˆ·æ‰èƒ½è®¿é—®
    const prompts = await getPremiumPrompts();
    res.json(prompts);
  }
);

// ç‰¹æ€§çº§åˆ«æ§åˆ¶
app.post('/api/v1/advanced-generate',
  authenticate,
  requireFeatureAccess('advanced-models'),
  async (req, res) => {
    // æ£€æŸ¥æ˜¯å¦æœ‰æƒä½¿ç”¨é«˜çº§æ¨¡å‹
    const result = await generateWithAdvancedModel(req.body);
    res.json(result);
  }
);
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³å¯åš
- âœ… æµ‹è¯•æ‰€æœ‰è®¢é˜…åŠŸèƒ½
- âœ… è‡ªå®šä¹‰è®¢é˜…è®¡åˆ’
- âœ… è°ƒæ•´ UI æ ·å¼
- âœ… æ·»åŠ æ›´å¤šåŠŸèƒ½è®¿é—®æ§åˆ¶

### å‡†å¤‡ä¸Šçº¿æ—¶
- ğŸ“ æ³¨å†Œ Stripe è´¦å·
- ğŸ“ é…ç½®ç”Ÿäº§å¯†é’¥
- ğŸ“ è®¾ç½® Webhook
- ğŸ“ æµ‹è¯•æ”¯ä»˜æµç¨‹

### åç»­ä¼˜åŒ–
- ğŸ“ˆ æ·»åŠ å¹´ä»˜æŠ˜æ‰£
- ğŸ“ˆ å®ç°ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- ğŸ“ˆ æ·»åŠ è®¢é˜…åˆ†æ
- ğŸ“ˆ é‚®ä»¶é€šçŸ¥åŠŸèƒ½

---

## ğŸ’¡ å°è´´å£«

1. **å¼€å‘é˜¶æ®µ**: ä¿æŒ `STRIPE_TEST_MODE=true`ï¼Œå¿«é€Ÿè¿­ä»£
2. **æµ‹è¯•è„šæœ¬**: ç»å¸¸è¿è¡Œ `test-subscription.js` éªŒè¯åŠŸèƒ½
3. **æŸ¥çœ‹æ—¥å¿—**: åç«¯ä¼šè¾“å‡ºè¯¦ç»†çš„è®¢é˜…æ“ä½œæ—¥å¿—
4. **æ•°æ®åº“æŸ¥è¯¢**: ä½¿ç”¨ SQL æŸ¥çœ‹è®¢é˜…çŠ¶æ€
   ```sql
   SELECT u.username, u.subscription_tier, s.status 
   FROM users u 
   LEFT JOIN subscriptions s ON u.id = s.user_id;
   ```

---

## ğŸ‰ å®Œæˆï¼

è®¢é˜…ç³»ç»Ÿå·²ç»å®Œæ•´å®ç°å¹¶å¯ä»¥ç«‹å³ä½¿ç”¨ï¼

**ç«‹å³å¼€å§‹**:
```bash
# 1. ç¡®ä¿æµ‹è¯•æ¨¡å¼å·²å¯ç”¨
echo "STRIPE_TEST_MODE=true" >> backend/.env

# 2. å¯åŠ¨æœåŠ¡
cd backend && npm run dev
cd frontend && npm run dev

# 3. è®¿é—®å®šä»·é¡µé¢
# http://localhost:5173/pricing

# 4. å¼€å§‹æµ‹è¯•ï¼
```

**éœ€è¦å¸®åŠ©ï¼Ÿ**
- æŸ¥çœ‹ `SUBSCRIPTION_GUIDE.md`
- è¿è¡Œ `test-subscription.js`
- æ£€æŸ¥åç«¯æ—¥å¿—

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€

---

*æœ€åæ›´æ–°: 2025-10-26*  
*ç‰ˆæœ¬: 1.0.0*

