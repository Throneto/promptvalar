# 问题修复报告 - 2025-10-29

## 问题概述

用户报告了两个主要问题：
1. **浏览器控制台警告**：Meta 标签 `apple-mobile-web-app-capable` 已弃用
2. **API 500 错误**：`/api/v1/ai/generate-prompt` 返回 500 错误

## 问题分析

### 问题 1: Meta 标签弃用警告
- **原因**：`apple-mobile-web-app-capable` 是旧的 iOS 专用标签
- **影响**：浏览器控制台显示弃用警告
- **建议**：添加标准的 `mobile-web-app-capable` 标签

### 问题 2: API 500 错误
- **根本原因**：OpenRouter API 认证失败（401 User not found）
- **错误日志**：
  ```
  OpenRouter API error: AuthenticationError: 401 User not found.
  ```
- **原因分析**：旧的 API Key (`sk-or-v1-5675...`) 已失效或账户余额不足

## 修复方案

### 1. 修复 Meta 标签（✅ 已完成）

**修改文件**：`frontend/index.html`

**添加内容**：
```html
<!-- 移动应用优化 -->
<meta name="mobile-web-app-capable" content="yes" />
```

**位置**：在现有的 iOS Safari 优化标签之前

### 2. 更新 OpenRouter API Key（✅ 已完成）

#### 步骤 1: 更新 backend/.env
```bash
sed -i 's/sk-or-v1-your-key-here/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/' /root/promptvalar/backend/.env
```

#### 步骤 2: 更新 PM2 配置
**修改文件**：`/var/www/promptvalar/deployment/ecosystem.config.js`

**修改内容**：
```javascript
OPENROUTER_API_KEY: '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'
```

#### 步骤 3: 重新加载服务
```bash
pm2 delete promptvalar-backend
cd /var/www/promptvalar/deployment && pm2 start ecosystem.config.js
pm2 save
```

### 3. 部署前端更新（✅ 已完成）

```bash
cd /root/promptvalar/frontend
npm run build
rsync -av --delete dist/ /var/www/promptvalar/frontend/
```

## 验证测试

### API Key 验证
```bash
curl -X POST "https://openrouter.ai/api/v1/chat/completions" \
  -H "Authorization: Bearer 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" \
  -H "Content-Type: application/json" \
  -d '{"model": "anthropic/claude-3.5-sonnet", "messages": [{"role": "user", "content": "测试"}], "max_tokens": 10}'
```

**结果**：✅ 成功返回响应

### API 端点测试
```bash
curl -X POST https://api.promptvalar.com/api/v1/ai/generate-prompt \
  -H "Content-Type: application/json" \
  -d '{"idea": "机器人在未来城市中奔跑", "model": "sora", "style": "cinematic"}'
```

**结果**：✅ 成功生成提示词
```json
{
  "success": true,
  "data": {
    "prompt": "A sleek humanoid robot...",
    "structured": {...},
    "logId": "f8b59141-3356-4cbd-95c7-4e76fb0aa483"
  }
}
```

## 修复结果

| 问题 | 状态 | 修复方式 |
|------|------|----------|
| Meta 标签弃用警告 | ✅ 已解决 | 添加 `mobile-web-app-capable` 标签 |
| API 500 错误 | ✅ 已解决 | 更新 OpenRouter API Key 并重启服务 |
| 前端部署 | ✅ 完成 | 构建并同步到生产环境 |
| 后端服务 | ✅ 正常运行 | PM2 进程正常，API 响应正常 |

## 后续建议

1. **监控 API Key 余额**：定期检查 OpenRouter 账户余额，避免再次出现认证失败
2. **设置告警**：配置余额低于阈值时的邮件通知
3. **API Key 轮换策略**：建议定期更新 API Key 以提高安全性
4. **日志监控**：定期检查 PM2 日志以及时发现问题

## 相关文件

- ✅ `/root/promptvalar/frontend/index.html` - Meta 标签已更新
- ✅ `/root/promptvalar/backend/.env` - API Key 已更新
- ✅ `/var/www/promptvalar/deployment/ecosystem.config.js` - PM2 配置已更新
- ✅ `/var/www/promptvalar/frontend/` - 生产环境前端已更新

## 命令快速参考

### 查看后端日志
```bash
pm2 logs promptvalar-backend --lines 50
```

### 查看 PM2 进程状态
```bash
pm2 status
```

### 查看环境变量
```bash
pm2 env 0 | grep OPENROUTER
```

### 重启后端服务
```bash
pm2 restart promptvalar-backend
```

---
**修复完成时间**：2025-10-29 21:25  
**验证状态**：✅ 所有功能正常

